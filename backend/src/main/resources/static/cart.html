<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito - Saturn Moon</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/styles.css">
</head>
<body>
    <!-- Navegación -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark-primary sticky-top shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="index.html">
                <i class="fas fa-moon me-2"></i>Saturn Moon
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="catalog.html">Catálogo</a></li>
                    <li class="nav-item"><a class="nav-link" href="wishlist.html"><i class="fas fa-heart"></i> Deseos</a></li>
                    <li class="nav-item"><a class="nav-link active" href="cart.html"><i class="fas fa-shopping-cart"></i> Carrito</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user"></i> Cuenta
                        </a>
                        <ul class="dropdown-menu dropdown-menu-dark">
                            <li><a class="dropdown-item" href="login.html" id="login-link">Iniciar Sesión</a></li>
                            <li><a class="dropdown-item" href="register.html">Registrarse</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="profile.html" id="profile-link" style="display:none;">Perfil</a></li>
                            <li><a class="dropdown-item" href="orders.html" id="orders-link" style="display:none;">Mis Pedidos</a></li>
                            <li><a class="dropdown-item" href="admin-dashboard.html" id="admin-link" style="display:none;">Panel Admin</a></li>
                            <li><a class="dropdown-item" href="#" id="logout-link" style="display:none;">Cerrar Sesión</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <div class="bg-light-bg border-bottom">
        <div class="container py-3">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="index.html" class="link-accent">Inicio</a></li>
                    <li class="breadcrumb-item active">Carrito de Compras</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div class="container py-5">
        <h1 class="mb-5 section-title">Mi Carrito de Compras</h1>

        <div class="row g-4">
            <!-- Lista de productos -->
            <div class="col-lg-8">
                <div id="emptyCart" class="alert alert-info text-center py-5" style="display: none;">
                    <i class="fas fa-shopping-cart" style="font-size: 48px; color: var(--violet-accent);"></i>
                    <p class="mt-3 mb-0">Tu carrito está vacío</p>
                    <a href="catalog.html" class="btn btn-accent mt-3">Explorar Catálogo</a>
                </div>

                <div id="cartItems" class="card border-0 shadow-sm">
                    <!-- Los artículos se cargarán aquí -->
                </div>
            </div>

            <!-- Resumen del pedido -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm sticky-top" style="top: 100px;">
                    <div class="card-body">
                        <h5 class="card-title fw-bold mb-4">
                            <i class="fas fa-receipt me-2"></i>Resumen del Pedido
                        </h5>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span id="subtotal">€0.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Envío:</span>
                                <span id="shipping">€5.00</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Impuestos (IVA 21%):</span>
                                <span id="tax">€0.00</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <span class="fw-bold">Total:</span>
                                <span class="fw-bold" style="color: var(--violet-accent); font-size: 18px;" id="total">€0.00</span>
                            </div>
                        </div>

                        <!-- Cupón descuento -->
                        <div class="mb-4">
                            <label class="form-label small fw-bold">Código de Descuento</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="couponInput" placeholder="Ingresa un código">
                                <button class="btn btn-outline-secondary" type="button" id="applyCoupon">
                                    <i class="fas fa-tag"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <button class="btn btn-accent w-100 py-2 fw-bold mb-2" id="checkoutBtn">
                            <i class="fas fa-credit-card me-2"></i>Proceder al Pago
                        </button>
                        <a href="catalog.html" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-arrow-left me-2"></i>Seguir Comprando
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Script personalizado -->
    <script>
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;

        const SHIPPING_COST = 5.00;
        const TAX_RATE = 0.21;

        // Renderizar carrito
        function renderCart() {
            const cartItemsContainer = document.getElementById('cartItems');
            const emptyCart = document.getElementById('emptyCart');

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '';
                emptyCart.style.display = 'block';
                updateTotals();
                return;
            }

            emptyCart.style.display = 'none';
            cartItemsContainer.innerHTML = cart.map((item, index) => `
                <div class="card-body border-bottom d-flex gap-3 py-4" style="border-bottom: 1px solid #ddd !important;">
                    <img src="${item.image}" alt="${item.name}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                    <div class="flex-grow-1">
                        <h6 class="fw-bold mb-1">${item.name}</h6>
                        <p class="small text-muted mb-2">${item.category}</p>
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <span class="small fw-bold">Cantidad:</span>
                            <div class="input-group input-group-sm" style="width: 100px;">
                                <button class="btn btn-outline-secondary" onclick="updateQuantity(${index}, ${item.quantity - 1})">-</button>
                                <input type="text" class="form-control text-center" value="${item.quantity}" disabled>
                                <button class="btn btn-outline-secondary" onclick="updateQuantity(${index}, ${item.quantity + 1})">+</button>
                            </div>
                        </div>
                        <p class="mb-0 small"><strong>€${(item.price * item.quantity).toFixed(2)}</strong></p>
                    </div>
                    <div class="text-end">
                        <p class="mb-2 small">€${item.price.toFixed(2)}</p>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            updateTotals();
        }

        // Actualizar cantidad
        function updateQuantity(index, newQuantity) {
            if (newQuantity < 1) return;
            cart[index].quantity = newQuantity;
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCart();
        }

        // Eliminar del carrito
        function removeFromCart(index) {
            const productName = cart[index].name;
            cart.splice(index, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            showNotification(`${productName} eliminado del carrito`, 'info');
            renderCart();
        }

        // Actualizar totales
        function updateTotals() {
            const subtotal = cart.reduce((total, item) => total + (item.price * item.quantity), 0);
            const tax = subtotal * TAX_RATE;
            const shipping = cart.length > 0 ? SHIPPING_COST : 0;
            const total = subtotal + tax + shipping;

            document.getElementById('subtotal').textContent = '€' + subtotal.toFixed(2);
            document.getElementById('tax').textContent = '€' + tax.toFixed(2);
            document.getElementById('shipping').textContent = '€' + shipping.toFixed(2);
            document.getElementById('total').textContent = '€' + total.toFixed(2);
        }

        // Aplicar cupón
        document.getElementById('applyCoupon').addEventListener('click', function() {
            const coupon = document.getElementById('couponInput').value.toUpperCase();
            
            if (coupon === 'LUNA10') {
                showNotification('Cupón aplicado: 10% de descuento', 'success');
            } else if (coupon === 'SATURN20') {
                showNotification('Cupón aplicado: 20% de descuento', 'success');
            } else {
                showNotification('Cupón no válido', 'warning');
            }
        });

        // Proceder al pago
        document.getElementById('checkoutBtn').addEventListener('click', function() {
            if (!currentUser) {
                showNotification('Debes iniciar sesión para proceder', 'warning');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return;
            }

            if (cart.length === 0) {
                showNotification('El carrito está vacío', 'warning');
                return;
            }

            // Crear pedido
            const orders = JSON.parse(localStorage.getItem('orders')) || [];
            const newOrder = {
                id: Date.now(),
                userId: currentUser.id,
                items: [...cart],
                subtotal: parseFloat(document.getElementById('subtotal').textContent.replace('€', '')),
                tax: parseFloat(document.getElementById('tax').textContent.replace('€', '')),
                shipping: SHIPPING_COST,
                total: parseFloat(document.getElementById('total').textContent.replace('€', '')),
                status: 'pendiente',
                createdAt: new Date().toISOString(),
                shippingAddress: currentUser.address || {}
            };

            orders.push(newOrder);
            localStorage.setItem('orders', JSON.stringify(orders));

            // Vaciar carrito
            localStorage.setItem('cart', JSON.stringify([]));
            cart = [];

            showNotification('Pedido creado exitosamente!', 'success');
            setTimeout(() => window.location.href = 'orders.html', 1500);
        });

        // Notificaciones
        function showNotification(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.top = '80px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Configurar UI de autenticación
        function setupAuthUI() {
            const loginLink = document.getElementById('login-link');
            const profileLink = document.getElementById('profile-link');
            const ordersLink = document.getElementById('orders-link');
            const adminLink = document.getElementById('admin-link');
            const logoutLink = document.getElementById('logout-link');

            if (currentUser) {
                loginLink.style.display = 'none';
                profileLink.style.display = 'block';
                ordersLink.style.display = 'block';
                logoutLink.style.display = 'block';
                
                if (currentUser.role === 'admin') {
                    adminLink.style.display = 'block';
                }
            }

            logoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            });
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            if (!currentUser) {
                setTimeout(() => window.location.href = 'login.html', 1000);
                return;
            }
            renderCart();
            setupAuthUI();
        });
    </script>
</body>
</html>
